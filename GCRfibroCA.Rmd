#The Data
```{r}
#All the libraries needed for this script
library(ggplot2) #library for plotting
library(deSolve) # library for solving differential equations
library(gridExtra) #for plotting
library(minpack.lm) #for non-linear regression package

# Create dataframes that stores the data
Oxygen = data.frame(d = c(0, .0125, .02, .025, .05, .075, .1, .2, .4), 
                    CA = c(.24, 1.66, 2.43, 2.37, 1.16, 2.85, 2.58, 6.94, 6.91))

Si = data.frame(d = c(0, .02, .04, .06, .08, .1, .12, .2, .4, .8, 1.2), 
                    CA = c(.11, 1.26, 1.14, 1.58, 1.22, 1.89, 3.47, 4.6, 9.79, 27.01, 38.84))

Fe600 = data.frame(d = c(0, .01, .02, .04, .06, .08, .1, .12, .2, .4, .8), 
                     CA = c(.13, .76, .99, 1.2, 1.74, 1.28, 1.2, 1.7, 3.02, 5.52, 12.42))

Fe450 = data.frame(d = c(0, .02, .04, .06, .08, .1, .2, .4), 
                   CA = c(0, .86, .6, .8, 1.22, 2.02, 2.3, 4.77))

Fe300 = data.frame(d = c(0, .005, .01,  0.02, .04, .07, .1, .2, .4, .8), 
                   CA = c(0.41, 1.23, 1.47, 1.22, .97, 1.46, 1.21, 4.38, 6.22, 13.6))

Ti = data.frame(d = c(0,  0.02, .04, .06, .08, .1, .15, .3, .6), 
                   CA = c(0, 1.99, 1.88, 1.44, 2.67, 2.57, 2.50, 5.64, 11.19))

param = data.frame(ion = c("O", "Si", "Ti", "Fe600", "Fe450", "Fe300"),
                   Z = c(8, 14, 22, 26, 26, 26), L = c(75, 100, 125, 175, 195, 240), 
                   Z.beta = c(595, 690, 770, 1075, 1245, 1585))

#putting it in one big data frame
big_df = rbind(Oxygen, Si, Ti, Fe600, Fe450, Fe300)
big_df$Z = rep(param$Z, times = c(9, 11, 9, 11, 8, 10))
big_df$Z.beta = rep(param$Z.beta, times = c(9, 11, 9, 11, 8, 10))
big_df$L = rep(param$L, times = c(9, 11, 9, 11, 8, 10))
big_df$error = c(0.24, 0.63, 0.77, 0.75, 0.52, 0.82, 0.78, 1.31, 1.59, 0.12, 0.05, 0.07, 0.56, 0.18, 0.60, 1.23, 1.60, 1.55, 4.27, 7.21, 0, 0.70, 0.66, 0.59, 0.80, 0.78, 0.48, 1.15, 2.39, 0.16, 0.38, 0.24, 0.21, 0.02, 0.37, 0.54, 0.17, 0.55, 1.75, 2.59, 0, 0.43, 0.34, 0.40, 0.50, 0.64, 0.73, 1.09, 0.29, 0.55, 0.60, 0.55, 0.49, 0.60, 0.54, 1.03, 1.22, 3.62)
big_df$ion = rep(param$ion, times = c(9, 11, 9, 11, 8, 10))

#will modify the data frame to get rid of the zero dose points irrelevant to the parameter estimation
modified_df = big_df[big_df$d != 0, ]
modified_df$CA = modified_df$CA*0.01
modified_df$error = modified_df$error*0.01
big_df$CA = big_df$CA * 0.01
big_df$error = big_df$error * 0.01
big_df$errorbar_lower = big_df$CA - big_df$error
big_df$errorbar_upper = big_df$CA + big_df$error
```

#NTE1 and NTE2 models in Cacao's report using their parameters
```{r}
#NTE1 function
NTE1_function = function(d, L, Z.beta, eta0 = 0.00011, eta1 = 0.007, sig0 = 6.12, kap = 796) {
0.0017 + eta0*L*exp(-eta1*L)*(d != 0) + 
    (6.242*(d/L))*(sig0*(1-exp(-Z.beta/kap))^2 + 0.041/6.24*L*(1 - (1-exp(-Z.beta/kap))^2))
} 

#NTE2 function
NTE2_function = function(d, L, Z.beta, eta0 = 0.00047, eta1 = 0.011, sig0 = 6.75, kap = 590) {
0.0017 + eta0*L*exp(-eta1*L)*exp(-(1012*(d/L)))*(d != 0) + 
    (6.242*(d/L))*(1-exp(-(1012*(d/L))))*
    (sig0*(1-exp(-Z.beta/kap))^2 + 0.041/6.24*L*(1 - (1-exp(-Z.beta/kap))^2))
} 
```

#Our IDER and calibration - t4.1 - 4.2
```{r}
#our proposed function
IDER = function(d, L, Z.beta, eta0, eta1, sig0, kap) {
  P = (1-exp(-Z.beta/kap))^2
  sig = sig0*P + 0.041/6.24*L*P
  eta = eta0*L*exp(-eta1*L)
  0.00071+ sig*6.24*d/L*(1-exp(-1024*d/L)) + eta*(1-exp(-10^5*d))
} 

#nls method to get the parameters needed (4 parameter estimation)
IDER_model = nlsLM(CA ~ IDER(d, L, Z.beta, eta0, eta1, sig0, kap), data = modified_df, start = list(eta0 = 0.001, eta1 = 0.01, sig0 = 5, kap = 500), 
weights = (1/(modified_df$error)^2))
coef(IDER_model)
#eta0 = 1.479796e-04, eta1 = 3.480127e-03, sig0 = 2.467512e+00, kap = 2.523256e+02 
vcov(IDER_model)
summary(IDER_model, cor = TRUE)
```

#Information crieteria (AIC and BIC) - t4.3
```{r}
#L_function gives the residuals squared
L_function = function(func, eta0, eta1, sig0, kap) {
  a = vector(length = 0)
  for (i in 1:length(modified_df[, 1])) {
    a = c(a, modified_df$CA[i] - func(d = modified_df$d[i], L = modified_df$L[i], Z.beta = modified_df$Z.beta[i], eta0 = eta0, eta1 = eta1, sig0 = sig0, kap = kap))
  }
  return(a^2)
}
L_NTE1 = L_function(NTE1_function, eta0 = 0.00011, eta1 = 0.007, sig0 = 6.12, kap = 796)
L_NTE2 = L_function(NTE2_function, eta0 = 0.00047, eta1 = 0.011, sig0 = 6.75, kap = 590)
L_IDER = L_function(IDER, eta0 = 1.479796e-04, eta1 = 3.480127e-03, sig0 = 2.467512e+00, kap = 2.523256e+02)

#Since all models both used in this report and Cacao's are weighted least square regression, will weight it with our weights to get the WRSS (weighted residual squared sum)
WRSS_NTE1 = sum((1/modified_df$error^2)*L_NTE1)
WRSS_NTE2 = sum((1/modified_df$error^2)*L_NTE2)
WRSS_IDER = sum((1/modified_df$error^2)*L_IDER)

#Definition of AIC and BIC calculation for Weighted Least Square regression
AIC_function = function(RSS, k = 4, n = length(modified_df[ , 1])) {
  n + n*log(2*pi) + n*log(RSS/n) + 2*(k+1)
}

BIC_function = function(n = length(modified_df[, 1]), k = 4, RSS) {
  n + n*log(2*pi) + n*log(RSS/n) + log(n)*(k+1)
}

NTE1_AIC = AIC_function(RSS = WRSS_NTE1)
NTE2_AIC = AIC_function(RSS = WRSS_NTE2)
IDER_AIC = AIC_function(RSS = WRSS_IDER)
NTE1_BIC = BIC_function(RSS = WRSS_NTE1)
NTE2_BIC = BIC_function(RSS = WRSS_NTE2)
IDER_BIC = BIC_function(RSS = WRSS_IDER)
information_critera_df = data.frame(AIC = c(NTE1_AIC, NTE2_AIC, IDER_AIC), BIC = c(NTE1_BIC, NTE2_BIC, IDER_BIC), row.names = c("NTE1 model", "NTE2 model", "IDER model"))
information_critera_df
```

#Creating a general function that will give MIXDER based on any input
```{r}
MIXDER_function = function(r, L, Z.beta, d = seq(0, 0.2, by = 0.001), eta0 = 1.300771e-04, eta1 = 3.164156e-03, sig0 = 2.481817e+00, kap = 2.565276e+02) {
  dE=function(yini,State,Pars){
  eta0 = eta0; eta1 = eta1; sig0 = sig0; kap = kap
  with(as.list(c(State, Pars)), {
    P = vector(length = length(L))
    sig = vector(length = length(L))
    etaa = vector(length = length(L))
    u = vector(length = length(L))
    for (i in 1:length(L)) {
      P[i] = (1-exp(-Z.beta[i]/kap))^2
      sig[i] = sig0*P[i] + 0.041/6.24*L[i]*P[i]
      etaa[i] = eta0*L[i]*exp(-eta1*L[i])
      u[i] = uniroot(function(d) sig[i]*6.24*d/L[i]*(1-exp(-1024*d/L[i])) + etaa[i]*(1-exp(-10^5*d)) - I, lower = 0, upper = d[length(d)]*100+1, tol = 10^-10)$root
    }
    dI = vector(length = length(L))
    for (i in 1:length(L)) {
      dI[i] = r[i]*(sig[i]*6.24/L[i]*exp(-1024*u[i]/L[i])*(exp(1024*u[i]/L[i]) + 1024*u[i]/L[i] - 1) + etaa[i]*10^5*exp(-10^5*u[i]))
    }
    dI = sum(dI)
    return(list(c(dI)))
    })
  }
  pars = NULL; yini = c(I= 0); d = d
  out = ode(yini,times = d, dE, pars, method = "radau")
  return(out)
}
#Note I had to make ode solver and uniroot to work together in this algorithmn. The alogirthmn is a recursive loop that finds the root at every turn of the inputted dose, quite computationally taxing. #Note: Had to use method = "radau" or else the small dose points with high concavity will not have accurate effect and causes massive accumulated errors later. This procedure in general is quite computationally taxing
```

#Graphs for NTE1 and IDER model 12_ion figure - fig. f4.3ff.
```{r, eval = F}
#When creating any sort of figures we use this IDER now without the background effect then add the background effect at the end.
IDER = function(d, L, Z.beta, eta0 = 1.479796e-04, eta1 = 3.480127e-03, sig0 = 2.467512e+00, kap = 2.523256e+02) {
  P = (1-exp(-Z.beta/kap))^2
  sig = sig0*P + 0.041/6.24*L*P
  eta = eta0*L*exp(-eta1*L)
  sig*6.24*d/L*(1-exp(-1024*d/L)) + eta*(1-exp(-10^5*d))
} 

#Comparing their NTE1 model and our IDER Model

#Use these dose points toe generate the curves necessary. Had to include a lot more dose points at lower doses when it is very sensitive to change
d_O = c(0, 1e-6*(1:9), 1e-5*(1:9), 1e-4*(1:9), 1e-3*(1:9), 1e-2*(1:9), 0.01*(10:40))
d_1 = c(0, 1e-6*(1:9), 1e-5*(1:9), 1e-4*(1:9), 1e-3*(1:9), 1e-2*(1:9), 0.01*(10:15))

oxygen = ggplot() + geom_errorbar(data = big_df[1:9, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[1:9]*100, y = 100*big_df$CA[1:9])) + geom_line(aes(x = d_O * 100,  y = 100*(0.00071 + IDER(d = d_O, L = 75, Z.beta = 595)), col = "IDER model")) + geom_line(aes(x = d_O * 100, y = 100 * NTE1_function(d = d_O, L= 75, Z.beta = 595), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Oxygen") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

oxygen_zoomout = ggplot() + geom_errorbar(data = big_df[1:7, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey") + geom_point(aes(x = big_df$d[1:7]*100, y = 100*big_df$CA[1:7])) + geom_line(aes(x = d_1 * 100,  y = 100*(0.00071 + IDER(d = d_1, L = 75, Z.beta = 595)), col = "IDER model")) + geom_line(aes(x = d_1 * 100, y = 100*NTE1_function(d = d_1, L= 75, Z.beta = 595), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Oxygen") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + ylim(0, 4)

d_S = c(0, 1e-6*(1:9), 1e-5*(1:9), 1e-4*(1:9), 1e-3*(1:9), 1e-2*(1:9), 0.01*(10:120))

silicon = ggplot() + geom_errorbar(data = big_df[10:20, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[10:20]*100, y = 100*big_df$CA[10:20])) + geom_line(aes(x = d_S * 100,  y = 100*(0.00071 + IDER(d = d_S, L = 100, Z.beta = 690)), col = "IDER model")) + geom_line(aes(x = d_S * 100, y = 100 * NTE1_function(d = d_S, L= 100, Z.beta = 690), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Silicon") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

silicon_zoomout = ggplot() + geom_errorbar(data = big_df[10:17, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey") + geom_point(aes(x = big_df$d[10:17]*100, y = 100*big_df$CA[10:17])) + geom_line(aes(x = d_1 * 100,  y = 100*(0.00071 + IDER(d = d_1, L = 100, Z.beta = 690)), col = "IDER model")) + geom_line(aes(x = d_1 * 100, y = 100*NTE1_function(d = d_1, L= 100, Z.beta = 690), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Silicon") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + ylim(0, 4) + xlim(0, 15)

d_t = c(0, 1e-6*(1:9), 1e-5*(1:9), 1e-4*(1:9), 1e-3*(1:9), 1e-2*(1:9), 0.01*(10:60))

titanium = ggplot() + geom_errorbar(data = big_df[21:29, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[21:29]*100, y = 100*big_df$CA[21:29])) + geom_line(aes(x = d_t * 100,  y = 100*(0.00071 + IDER(d = d_t, L = 125, Z.beta = 770)), col = "IDER model")) + geom_line(aes(x = d_t * 100, y = 100 * NTE1_function(d = d_t, L= 125, Z.beta = 770), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Titanium") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

titanium_zoomout = ggplot() + geom_errorbar(data = big_df[21:27, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey") + geom_point(aes(x = big_df$d[21:27]*100, y = 100*big_df$CA[21:27])) + geom_line(aes(x = d_1 * 100,  y = 100*(0.00071 + IDER(d = d_1, L = 125, Z.beta = 770)), col = "IDER model")) + geom_line(aes(x = d_1 * 100, y = 100*NTE1_function(d = d_1, L= 125, Z.beta = 770), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Titanium") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + ylim(0, 4) + xlim(0, 15)

d_six = c(0, 1e-6*(1:9), 1e-5*(1:9), 1e-4*(1:9), 1e-3*(1:9), 1e-2*(1:9), 0.01*(10:85))

iron_six = ggplot() + geom_errorbar(data = big_df[30:40, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[30:40]*100, y = 100*big_df$CA[30:40])) + geom_line(aes(x = d_six * 100,  y = 100*(0.00071 + IDER(d = d_six, L = 175, Z.beta = 1075)), col = "IDER model")) + geom_line(aes(x = d_six * 100, y = 100 * NTE1_function(d = d_six, L= 175, Z.beta = 1075), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Fe600") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

iron_six_zoomout = ggplot() + geom_errorbar(data = big_df[30:37, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey") + geom_point(aes(x = big_df$d[30:37]*100, y = 100*big_df$CA[30:37])) + geom_line(aes(x = d_1 * 100,  y = 100*(0.00071 + IDER(d = d_1, L = 175, Z.beta = 1075)), col = "IDER model")) + geom_line(aes(x = d_1 * 100, y = 100*NTE1_function(d = d_1, L= 175, Z.beta = 1075), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Fe600") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + ylim(0, 4) + xlim(0, 15)

d_four = c(0, 1e-6*(1:9), 1e-5*(1:9), 1e-4*(1:9), 1e-3*(1:9), 1e-2*(1:9), 0.01*(10:45))

iron_four = ggplot() + geom_errorbar(data = big_df[41:48, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[41:48]*100, y = 100*big_df$CA[41:48])) + geom_line(aes(x = d_four * 100,  y = 100*(0.00071 + IDER(d = d_four, L = 195, Z.beta = 1245)), col = "IDER model")) + geom_line(aes(x = d_four * 100, y = 100 * NTE1_function(d = d_four, L= 195, Z.beta = 1245), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Fe450") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

iron_four_zoomout = ggplot() + geom_errorbar(data = big_df[41:46, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey") + geom_point(aes(x = big_df$d[41:46]*100, y = 100*big_df$CA[41:46])) + geom_line(aes(x = d_1 * 100,  y = 100*(0.00071 + IDER(d = d_1, L = 195, Z.beta = 1245)), col = "IDER model")) + geom_line(aes(x = d_1 * 100, y = 100*NTE1_function(d = d_1, L= 195, Z.beta = 1245), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Fe450") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + ylim(0, 4) + xlim(0, 15)

d_three = c(0, 1e-6*(1:9), 1e-5*(1:9), 1e-4*(1:9), 1e-3*(1:9), 1e-2*(1:9), 0.01*(10:80))

iron_three = ggplot() + geom_errorbar(data = big_df[49:58, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[49:58]*100, y = 100*big_df$CA[49:58])) + geom_line(aes(x = d_three * 100,  y = 100*(0.00071 + IDER(d = d_three, L = 240, Z.beta = 1585)), col = "IDER model")) + geom_line(aes(x = d_three * 100, y = 100 * NTE1_function(d = d_three, L= 240, Z.beta = 1585), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Fe300") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

iron_three_zoomout = ggplot() + geom_errorbar(data = big_df[49:55, ], aes(x = d*100, ymin = 100*errorbar_lower, ymax = 100*errorbar_upper), col = "grey") + geom_point(aes(x = big_df$d[49:55]*100, y = 100*big_df$CA[49:55])) + geom_line(aes(x = d_1 * 100,  y = 100*(0.00071 + IDER(d = d_1, L = 240, Z.beta = 1585)), col = "IDER model")) + geom_line(aes(x = d_1 * 100, y = 100*NTE1_function(d = d_1, L= 240, Z.beta = 1585), col = "NTE1 model"), linetype = "dotted") + labs(x = "Dose (cGy)", y = "", title = "Fe300") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE1")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + ylim(0, 4) + xlim(0, 15)

setEPS()
postscript("12_ions.eps", width = 10, height = 7)
grid.arrange(oxygen, silicon, titanium, oxygen_zoomout, silicon_zoomout, titanium_zoomout, iron_six, iron_four, iron_three, iron_six_zoomout, iron_four_zoomout, iron_three_zoomout, ncol = 3)
dev.off()
```

#Graphs for the NTE2 and IDER model comparison 
```{r, eval = F}
#Comparing our IDER model with their NTE2 model
O = ggplot() + geom_errorbar(data = big_df[1:9, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[1:9], y = big_df$CA[1:9])) + geom_line(aes(x = d_O,  y = 0.00071 + IDER(d = d_O, L = 75, Z.beta = 595), col = "IDER model")) + geom_line(aes(x = d_O, y = NTE2_function(d = d_O, L= 75, Z.beta = 595), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Oxygen") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

S = ggplot() + geom_errorbar(data = big_df[10:20, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[10:20], y = big_df$CA[10:20])) + geom_line(aes(x = d_S,  y = 0.00071 + IDER(d = d_S, L = 100, Z.beta = 690), col = "IDER model")) + geom_line(aes(x = d_S, y = NTE2_function(d = d_S, L= 100, Z.beta = 690), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Silicon") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + xlim(0, 0.4) + ylim(0,0.12)

Ti = ggplot() + geom_errorbar(data = big_df[21:29, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[21:29], y = big_df$CA[21:29])) + geom_line(aes(x = d_t,  y = 0.00071 + IDER(d = d_t, L = 125, Z.beta = 770), col = "IDER model")) + geom_line(aes(x = d_t, y = NTE2_function(d = d_t, L= 125, Z.beta = 770), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Titanium") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + xlim(0, 0.4) + ylim(0, 0.075)

i_6 = ggplot() + geom_errorbar(data = big_df[30:40, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[30:40], y = big_df$CA[30:40])) + geom_line(aes(x = d_six,  y = 0.00071 + IDER(d = d_six, L = 175, Z.beta = 1075), col = "IDER model")) + geom_line(aes(x = d_six, y = NTE2_function(d = d_six, L= 175, Z.beta = 1075), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Fe600") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + xlim(0, 0.4) + ylim(0, 0.06)

i_4 = ggplot() + geom_errorbar(data = big_df[41:48, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[41:48], y = big_df$CA[41:48])) + geom_line(aes(x = d_four,  y = 0.00071 + IDER(d = d_four, L = 195, Z.beta = 1245), col = "IDER model")) + geom_line(aes(x = d_four, y = NTE2_function(d = d_four, L= 195, Z.beta = 1245), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Fe450") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

i_3 = ggplot() + geom_errorbar(data = big_df[49:58, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[49:58], y = big_df$CA[49:58])) + geom_line(aes(x = d_three,  y = 0.00071 + IDER(d = d_three, L = 240, Z.beta = 1585), col = "IDER model")) + geom_line(aes(x = d_three, y = NTE2_function(d = d_three, L = 240, Z.beta = 1585), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Fe300") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + xlim(0, 0.4) + ylim(0, 0.08)

setEPS()
postscript("6_ions.eps", width = 10, height = 7)
grid.arrange(O, S, Ti, i_6, i_4, i_3, ncol = 3)
dev.off()
```

#Continuation for the 6 other panels of NTE2 comparison
```{r, eval = F}
#Comparing our IDER model with their NTE2 model
O = ggplot() + geom_errorbar(data = big_df[1:9, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[1:9], y = big_df$CA[1:9])) + geom_line(aes(x = d_O,  y = 0.00071 + IDER(d = d_O, L = 75, Z.beta = 595), col = "IDER model")) + geom_line(aes(x = d_O, y = NTE2_function(d = d_O, L= 75, Z.beta = 595), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Oxygen") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

S = ggplot() + geom_errorbar(data = big_df[10:20, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[10:20], y = big_df$CA[10:20])) + geom_line(aes(x = d_S,  y = 0.00071 + IDER(d = d_S, L = 100, Z.beta = 690), col = "IDER model")) + geom_line(aes(x = d_S, y = NTE2_function(d = d_S, L= 100, Z.beta = 690), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Silicon") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

Ti = ggplot() + geom_errorbar(data = big_df[21:29, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[21:29], y = big_df$CA[21:29])) + geom_line(aes(x = d_t,  y = 0.00071 + IDER(d = d_t, L = 125, Z.beta = 770), col = "IDER model")) + geom_line(aes(x = d_t, y = NTE2_function(d = d_t, L= 125, Z.beta = 770), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Titanium") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

i_6 = ggplot() + geom_errorbar(data = big_df[30:40, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[30:40], y = big_df$CA[30:40])) + geom_line(aes(x = d_six,  y = 0.00071 + IDER(d = d_six, L = 175, Z.beta = 1075), col = "IDER model")) + geom_line(aes(x = d_six, y = NTE2_function(d = d_six, L= 175, Z.beta = 1075), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Fe600") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) 

i_4 = ggplot() + geom_errorbar(data = big_df[41:48, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[41:48], y = big_df$CA[41:48])) + geom_line(aes(x = d_four,  y = 0.00071 + IDER(d = d_four, L = 195, Z.beta = 1245), col = "IDER model")) + geom_line(aes(x = d_four, y = NTE2_function(d = d_four, L= 195, Z.beta = 1245), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Fe450") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm"))

i_3 = ggplot() + geom_errorbar(data = big_df[49:58, ], aes(x = d, ymin = errorbar_lower, ymax = errorbar_upper), col = "grey")  + geom_point(aes(x = big_df$d[49:58], y = big_df$CA[49:58])) + geom_line(aes(x = d_three,  y = 0.00071 + IDER(d = d_three, L = 240, Z.beta = 1585), col = "IDER model")) + geom_line(aes(x = d_three, y = NTE2_function(d = d_three, L = 240, Z.beta = 1585), col = "NTE2 model"), linetype = 2) + labs(x = "Dose (Gy)", y = "CA", title = "Fe300") + scale_colour_manual(guide = FALSE, name = "Models", values = c("red", "blue"), label = c("IDER", "NTE2")) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) 

setEPS()
postscript("6_ions_2.eps", width = 10, height = 7)
grid.arrange(O, S, Ti, i_6, i_4, i_3, ncol = 3)
dev.off()
```

#Iron and Silicon 2_ion analysis - fig f4.4.1ff.
```{r}
#will create a figure that will do synergy analysis on Silicon and Fe600 and compare it with the simple effect addtivity and the individual IDER curves.
#first figure from d = 0 - 0.1 cGy
d1 = seq(0, 0.001, 0.00001)
out = MIXDER_function(r = c(0.5, 0.5), L = c(100, 175), Z.beta = c(690, 1075), d = d1)
simple_effect = IDER(d = 0.5*d1, L = 100, Z.beta = 690) + IDER(d = 0.5*d1, L = 175, Z.beta = 1075)

g_1_I = out[, 2] + 0.00071
g_1_s =simple_effect + 0.00071
si_IDER = IDER(d = d1, L = 100, Z.beta = 690) + 0.00071
iron_IDER = IDER(d = d1, L = 175, Z.beta = 1075) + 0.00071
figure_one = data.frame(d = d1, g_1_I, g_1_s, si_IDER, iron_IDER)

fig_one = ggplot(data = figure_one) + geom_line(aes(x = d * 100, y = g_1_I * 100), col = "red") + geom_line(aes(x = d * 100, y = g_1_s * 100), col = "black") + labs(x = "", y = "", title = "") + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + geom_line(aes(x = d * 100, y = 100* si_IDER), col = "blue", linetype = "dotted") + geom_line(aes(x = d * 100, y = 100* iron_IDER), col = "blue", linetype = "dotted") 

#second figure from d = 0 - 2
d2 = seq(0, 0.02, 0.0005)
out = MIXDER_function(r = c(0.5, 0.5), L = c(100, 175), Z.beta = c(690, 1075), d = d2)
simple_effect = IDER(d = 0.5*d2, L = 100, Z.beta = 690) + IDER(d = 0.5*d2, L = 175, Z.beta = 1075)

g_1_I = out[, 2] + 0.00071
g_1_s =simple_effect + 0.00071
si_IDER = IDER(d = d2, L = 100, Z.beta = 690) + 0.00071
iron_IDER = IDER(d = d2, L = 175, Z.beta = 1075) + 0.00071
figure_two = data.frame(d = d2, g_1_I, g_1_s, si_IDER, iron_IDER)

fig_two = ggplot(data = figure_two) + geom_line(aes(x = d * 100, y = g_1_I * 100), col = "red") + geom_line(aes(x = d * 100, y = g_1_s * 100), col = "black") + labs(x = "", y = "", title = "") + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + geom_line(aes(x = d * 100, y = 100* si_IDER), col = "blue", linetype = "dotted") + geom_line(aes(x = d * 100, y = 100* iron_IDER), col = "blue", linetype = "dotted")

#third figure from d = 0-500
d3 = c(seq(0, 0.01, 0.0005), seq(0.02, 0.5, 0.01))
out = MIXDER_function(r = c(0.5, 0.5), L = c(100, 175), Z.beta = c(690, 1075), d = d3)
simple_effect = IDER(d = 0.5*d3, L = 100, Z.beta = 690) + IDER(d = 0.5*d3, L = 175, Z.beta = 1075)

g_1_I = out[, 2] + 0.00071
g_1_s =simple_effect + 0.00071
si_IDER = IDER(d = d3, L = 100, Z.beta = 690) + 0.00071
iron_IDER = IDER(d = d3, L = 175, Z.beta = 1075) + 0.00071
figure_three = data.frame(d = d3, g_1_I, g_1_s, si_IDER, iron_IDER)

fig_three = ggplot(data = figure_three) + geom_line(aes(x = d * 100, y = g_1_I * 100), col = "red") + geom_line(aes(x = d * 100, y = g_1_s * 100), col = "black") + labs(x = "", y = "", title = "") + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + geom_line(aes(x = d * 100, y = 100* si_IDER), col = "blue", linetype = "dotted") + geom_line(aes(x = d * 100, y = 100* iron_IDER), col = "blue", linetype = "dotted")

setEPS()
postscript("fig_f4_0ff.eps", width = 12, height = 4)
grid.arrange(fig_one, fig_two, fig_three, ncol = 3)
dev.off()
#two blue curves are the individual IDER curves, red curve is the MIXDER curve (correct one) and the black one is the simple effect addtivity curve. We can already see the simple effect overestimating as expected. 
```

#Confidence intervals and monte carlo simulations
```{r}
#MonteCarlo using multivariate gaussian 
require(mvtnorm)
sig = vcov(IDER_model)
set.seed(10)
monte_carlo_parameters = rmvnorm(n = 1000, mean = c(eta0 = 1.479796e-04, eta1 = 3.480127e-03, sig0 = 2.467512e+00, kap = 2.523256e+02), sigma = sig)
eta0_MC = monte_carlo_parameters[, 1]
eta1_MC = monte_carlo_parameters[, 2]
sig0_MC = monte_carlo_parameters[, 3]
sig0_MC[sig0_MC < 0] = 1e-5
kap_MC = monte_carlo_parameters[, 4]
kap_MC[kap_MC <= 1e-6] = 1e-5 
#note because our last two parameters were less significant when inputting our variance covariance matrix the parameters had to actually be readjusted to fix for negative value. This is important because if one of our parameters went negative our model is nonsensical. (Luckily the fix was only for a few of the 1000 generated monte carlo simulations)

#This is a general CI_function where you just get a CI for a specific dose point for any synergy analysis using the monte carlo simulations using vcov
CI_function_MIXDER = function(d, d_interested, r, interval = 0.95, L, Z.beta) {
  MIXDER_curve = list(0)
  for (i in 1:500) {
    MIXDER_curve[[i]] = MIXDER_function(r = r, d = d, L = L, Z.beta = Z.beta, eta0 = eta0_MC[i], eta1 = eta1_MC[i], sig0 = sig0_MC[i], kap = kap_MC[i])
  }
  info = vector(length = 0)
  for (i in 1:500) {
    info = c(info, MIXDER_curve[[i]][, 2][2])
  }
  info = sort(info)
  lower_bound = info[(1-interval)/2*500]
  upper_bound = info[(interval + (1-interval)/2)*500]
  CI = c(lower_bound, upper_bound)
  return(CI)
}

#Monte Carlo using the error bars nls gave me
eta0_MC_2 = rnorm(1000, mean = 1.480e-04, sd = 2.174e-05)
eta1_MC_2 = rnorm(1000, mean = 3.48e-03, sd = 9.043e-04)
sig0_MC_2 = rnorm(1000, mean = 2.468, sd = 9.306e-01)
kap_MC_2 = rnorm(1000, mean = 2.523e+02, sd = 2.18e+02)
sig0_MC_2[sig0_MC_2 < 0] = 1e-5
kap_MC_2[kap_MC_2 <= 1e-6] = 1e-5 

CI_function_MIXDER_MC_2 = function(d, d_interested, r, interval = 0.95, L, Z.beta) {
  MIXDER_curve = list(0)
  for (i in 1:500) {
    MIXDER_curve[[i]] = MIXDER_function(r = r, d = d, L = L, Z.beta = Z.beta, eta0 = eta0_MC_2[i], eta1 = eta1_MC_2[i], sig0 = sig0_MC_2[i], kap = kap_MC_2[i])
  }
  info = vector(length = 0)
  for (i in 1:500) {
    info = c(info, MIXDER_curve[[i]][, 2][2])
  }
  info = sort(info)
  lower_bound = info[(1-interval)/2*500]
  upper_bound = info[(interval + (1-interval)/2)*500]
  CI = c(lower_bound, upper_bound)
  return(CI)
}
```

#95% CI ribbon for 2_ions - figf4.4.2ff
```{r}
#This is for the two_ion ribbon graph. Similarly, blues curves are individual IDERs and red curve the mixed IDER and the black the simple effect addtivity curve.

#First the MIXDER of the true curve 
out = MIXDER_function(r = rep(1/2, times = 2), L = c(100, 175), Z.beta = c(690, 1075), d = c(seq(0, 0.01, 0.001), seq(0.01, 0.5, by = 0.01)))
two_ion_MIXDER = data.frame(d = out[, 1], CA = out[, 2] + 0.00071)
d = two_ion_MIXDER$d
#Then the 95% CI multivariate MC simulated ribbon
ninty_five_CI_lower = vector(length = 0)
ninty_five_CI_upper = vector(length = 0)
a = vector(length = 0)
for (i in 2:length(d)) {
  a = CI_function_MIXDER(d = c(0, two_ion_MIXDER$d[i]), d_interested = two_ion_MIXDER$d[i], r = rep(1/2, times = 2),  L = c(100, 175), Z.beta = c(690, 1075))
  ninty_five_CI_lower = c(ninty_five_CI_lower, a[1])
  ninty_five_CI_upper = c(ninty_five_CI_upper, a[2])
}
two_ion_MIXDER$CI_lower = c(0, ninty_five_CI_lower + 0.00071)
two_ion_MIXDER$CI_upper = c(0, ninty_five_CI_upper + 0.00071)

#Get the simple effect additivity 
two_ion_MIXDER$simpleeffect = IDER(d = 0.5*d, L = 100, Z.beta = 690) + IDER(d = 0.5*d, L = 175, Z.beta = 1075) + 0.00071
#Get the individual IDERS
two_ion_MIXDER$silicon = IDER(d = d, L = 100, Z.beta = 690) + 0.00071
two_ion_MIXDER$ironsix = IDER(d = d, L = 175, Z.beta = 1075) + 0.00071
save(two_ion_MIXDER, file = "two_ion_95%.Rda")

#plotting the 95% ribbon graph for the two_ion
fig_44ff_2 = ggplot(data = two_ion_MIXDER, aes(x = d*100, y = CA* 100)) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + labs(x = "Dose (cGy)", y = "CA (%)", title = "Mixture of 2 ions") + geom_ribbon(aes(ymin = CI_lower* 100, ymax = CI_upper * 100), fill = "yellow") + geom_line(aes(y = CA * 100), col = "red") + geom_line(aes(y = simpleeffect * 100), col = "black") + geom_line(aes(y = silicon* 100), col = "green") + geom_line(aes(y = ironsix* 100), col = "green")

setEPS()
postscript("fig_4.4.2ff.eps", width = 6, height = 4)
fig_44ff_2
dev.off()
```

#6 ions analysis using 95% CI ribbons using both methods - fig f4.4.2ff
```{r}
#This is for the six_ion synergy analysis incorporating our monte carlo simulations with the darker grey the 95% confidence interval using our monte carlo simulated parameters and the lighter grey the 95% confidence interval using the error bars given by the non-linear regression model. Turns out the MC simulation creates smaller bars of error espicially for bigger doses. Similarly, blues curves are individual IDERs and red curve the mixed IDER and the black the simple effect addtivity curve.

#First the MIXDER of the true curve 
out = MIXDER_function(r = rep(1/6, times = 6), L = c(75, 100, 125, 175, 195, 240), Z.beta = c(595, 690, 770, 1075, 1245, 1585), d = c(seq(0, 0.01, 0.001), seq(0.01, 0.4, by = 0.01)))
six_ion_MIXDER = data.frame(d = out[, 1], CA = out[, 2] + 0.00071)
d = six_ion_MIXDER$d
#Then the 95% CI multivariate MC simulated ribbon
ninty_five_CI_lower = vector(length = 0)
ninty_five_CI_upper = vector(length = 0)
a = vector(length = 0)
for (i in 2:length(d)) {
  a = CI_function_MIXDER(d = c(0, six_ion_MIXDER$d[i]), d_interested = six_ion_MIXDER$d[i], r = rep(1/6, times = 6), L = c(75, 100, 125, 175, 195, 240), Z.beta = c(595, 690, 770, 1075, 1245, 1585))
  ninty_five_CI_lower = c(ninty_five_CI_lower, a[1])
  ninty_five_CI_upper = c(ninty_five_CI_upper, a[2])
}
six_ion_MIXDER$CI_lower = c(0, ninty_five_CI_lower + 0.00071)
six_ion_MIXDER$CI_upper = c(0, ninty_five_CI_upper + 0.00071)

#Then the 95% CI for the MC simulated independent gaussians
ninty_five_CI_lower_two = vector(length = 0)
ninty_five_CI_upper_two = vector(length = 0)
a = vector(length = 0)
for (i in 2:length(d)) {
  a = CI_function_MIXDER_MC_2(d = c(0, six_ion_MIXDER$d[i]), d_interested = six_ion_MIXDER$d[i], r = rep(1/6, times = 6), L = c(75, 100, 125, 175, 195, 240), Z.beta = c(595, 690, 770, 1075, 1245, 1585))
  ninty_five_CI_lower_two = c(ninty_five_CI_lower_two, a[1])
  ninty_five_CI_upper_two = c(ninty_five_CI_upper_two, a[2])
}
six_ion_MIXDER$CI_lower_two = c(0, ninty_five_CI_lower_two + 0.00071)
six_ion_MIXDER$CI_upper_two = c(0, ninty_five_CI_upper_two + 0.00071)


#Get the simple effect additivity 
six_ion_MIXDER$simpleeffect = IDER(d = 1/6*d, L = 125, Z.beta = 770) + IDER(d = 1/6*d, L = 175, Z.beta = 1075) + IDER(d = 1/6*d, L = 75, Z.beta = 595) + IDER(d = 1/6*d, L = 100, Z.beta = 690) + IDER(d = 1/6*d, L = 195, Z.beta = 1245) + IDER(d = 1/6*d, L = 240, Z.beta = 1585) + 0.00071
#Get the individual IDERS
six_ion_MIXDER$oxygen = IDER(d = d, L = 75, Z.beta = 595) + 0.00071
six_ion_MIXDER$silicon = IDER(d = d, L = 100, Z.beta = 690) + 0.00071
six_ion_MIXDER$titanium = IDER(d = d, L = 125, Z.beta = 770) + 0.00071
six_ion_MIXDER$ironsix = IDER(d = d, L = 175, Z.beta = 1075) + 0.00071
six_ion_MIXDER$ironfour = IDER(d = d, L = 195, Z.beta = 1245) + 0.00071
six_ion_MIXDER$ironthree = IDER(d = d, L = 240, Z.beta = 1585) + 0.00071
save(six_ion_MIXDER, file = "Fig f4_2ff.Rda")

#plotting first figure for MC multivariate gaussian
fig_42ff_1 = ggplot(data = six_ion_MIXDER, aes(x = d*100, y = CA* 100)) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + labs(x = "Dose (cGy)", y = "CA (%)", title = "Mixture of 6 ions") + geom_ribbon(aes(ymin = CI_lower* 100, ymax = CI_upper * 100), fill = "grey90") + geom_line(aes(y = CA * 100), col = "red") + geom_line(aes(y = simpleeffect * 100), col = "black") + geom_line(aes(y = silicon* 100), col = "blue", linetype = "dotted") + geom_line(aes(y = titanium* 100), col = "blue", linetype = "dotted") + geom_line(aes(y = ironthree* 100), col = "blue", linetype = "dotted") + geom_line(aes(y = ironfour* 100), col = "blue", linetype = "dotted") + geom_line(aes(y = ironsix* 100), col = "blue", linetype = "dotted") + geom_line(aes(y = oxygen* 100), col = "blue", linetype = "dotted") 

#Plotting second figure independent gaussian
fig_42ff_2 = ggplot(data = six_ion_MIXDER, aes(x = d*100, y = CA* 100)) + theme_bw() + theme(axis.line.x = element_line(color="black", size = 0.3), axis.line.y = element_line(color="black", size = 0.3), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.ticks.y = element_line(size = 0.3), axis.ticks.x = element_line(size = 0.3), axis.text=element_text(size=12), axis.title=element_text(size=14), axis.ticks.length = unit(0.3, "cm")) + labs(x = "Dose (cGy)", y = "CA (%)", title = "Mixture of 6 ions") + geom_ribbon(aes(ymin = CI_lower_two* 100, ymax = CI_upper_two * 100), fill = "grey75") + geom_line(aes(y = CA * 100), col = "red") + geom_line(aes(y = simpleeffect * 100), col = "black") + geom_line(aes(y = silicon* 100), col = "blue", linetype = "dotted") + geom_line(aes(y = titanium* 100), col = "blue", linetype = "dotted") + geom_line(aes(y = ironthree* 100), col = "blue", linetype = "dotted") + geom_line(aes(y = ironfour* 100), col = "blue", linetype = "dotted") + geom_line(aes(y = ironsix* 100), col = "blue", linetype = "dotted") + geom_line(aes(y = oxygen* 100), col = "blue", linetype = "dotted") 

setEPS()
postscript("fig_42ff.eps", width = 12, height = 4)
grid.arrange(fig_42ff_1, fig_42ff_2, ncol = 2)
dev.off()
```

